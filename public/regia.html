<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Regia OGT - FINAL + ENTRATA</title>
    <style>
        :root { 
            --dark: #121212; --panel: #1e1e1e; --accent: #ffd700; 
            --red: #d32f2f; --green: #00e676; --blue: #1976d2;
            --purple: #7b1fa2; --orange: #f57c00; --teal: #009688;
            --pink: #e91e63; /* Nuovo colore per Entrata */
        }
        
        body { background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; height: 100vh; overflow: hidden; user-select: none; }
        
        /* Layout Grid */
        .main-grid { display: grid; grid-template-columns: 340px 1fr; gap: 10px; height: 100%; }
        
        /* Colonna sinistra scorrevole */
        .colonna-sx { display: flex; flex-direction: column; gap: 10px; height: 100%; overflow-y: auto; padding-right: 5px; min-height: 0; }
        .colonna-dx { display: flex; flex-direction: column; gap: 10px; height: 100%; min-height: 0; }
        
        .panel { background: var(--panel); padding: 12px; border-radius: 8px; border: 1px solid #333; flex-shrink: 0; }
        
        h2 { border-bottom: 1px solid #444; padding-bottom: 5px; margin: 0 0 8px 0; font-size: 0.95rem; color: var(--accent); display: flex; justify-content: space-between; align-items: center; }

        /* MONITOR */
        .monitor-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; margin-bottom: 8px; }
        .mini-slot { background: #000; padding: 5px; border-radius: 4px; text-align: center; border: 1px solid #333; font-size: 0.8rem; color: #666; }
        .mini-slot.attivo { background: #3c0b0b; border-color: var(--red); color: white; font-weight: bold; }
        
        .timer-box { background: black; border: 1px solid #444; border-radius: 6px; padding: 5px 10px; display: flex; justify-content: space-between; margin-bottom: 8px; }
        .timer-display { font-family: 'Courier New', monospace; font-size: 1.5rem; color: var(--accent); font-weight: bold; }
        
        /* BOTTONI RESET */
        .btn-reset-gara { width: 100%; padding: 10px; background: var(--red); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.9rem; margin-top: 5px; }
        .btn-reset-gara:hover { background: #b71c1c; }
        .btn-reset-totale { width: 100%; padding: 8px; background: #333; color: #aaa; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-top: 5px; }
        .btn-reset-totale:hover { background: #444; color: white; }

        /* PLAYLIST */
        .panel-playlist { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        .playlist-container { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .btn-concorrente { width: 100%; text-align: left; padding: 8px; margin-bottom: 3px; background: #2a2a2a; color: #ccc; border: none; border-left: 3px solid transparent; cursor: pointer; display: flex; justify-content: space-between; }
        .btn-concorrente:hover { background: #333; color: white; }
        .btn-concorrente.active { background: #333; color: var(--accent); border-left: 3px solid var(--accent); font-weight: bold; }

        /* AUDIO GRID (Aggiornata a 3 colonne per 6 bottoni) */
        .audio-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .btn-sound { border: none; padding: 12px 2px; font-size: 0.7rem; font-weight: bold; color: white; border-radius: 4px; cursor: pointer; position: relative; overflow: hidden; }
        .btn-sound.playing { box-shadow: inset 0 0 0 2px white; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        
        .bg-blue { background: var(--blue); } 
        .bg-purple { background: var(--purple); } 
        .bg-orange { background: var(--orange); } 
        .bg-green { background: var(--green); } 
        .bg-teal { background: var(--teal); }
        .bg-pink { background: var(--pink); } /* Nuovo stile */

        .sfx-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; }
        .btn-sfx { background: #37474f; color: #eceff1; padding: 8px 2px; font-size: 0.7rem; cursor: pointer; border: 1px solid #546e7a; border-radius: 4px; }
        .btn-sfx:active { transform: scale(0.95); }
        .btn-sfx.playing { background: #455a64; color: var(--accent); border-color: var(--accent); }

        /* CONTROLS & MIXER */
        .pro-controls { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-talkover { background: #ff9800; color: black; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; }
        .btn-talkover.active { background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .btn-panic { background: #b71c1c; color: white; font-weight: bold; border: 1px solid red; border-radius: 4px; cursor: pointer; }
        
        .mixer-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 6px; margin-top: 10px; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--accent); height: 5px; }
        input#volSfx { accent-color: #009688; }

        /* VIDEO & PROJECTOR STATUS */
        .right-bottom-container { flex-grow: 1; display: flex; flex-direction: column; gap: 10px; min-height: 0; }
        .panel-player { flex: 2; display: flex; flex-direction: column; min-height: 0; padding-bottom: 5px; }
        
        .video-wrapper { flex-grow: 1; width: 100%; background: black; border-radius: 6px; overflow: hidden; border: 1px solid #444; position: relative; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        .projector-status-bar { display: flex; justify-content: space-between; align-items: center; background: #000; padding: 5px 10px; border-radius: 4px; margin-bottom: 5px; border: 1px solid #333; }
        .status-led { width: 12px; height: 12px; border-radius: 50%; background: #333; display: inline-block; margin-right: 5px; transition: 0.2s; }
        .status-led.on { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .status-led.syncing { background: var(--orange); box-shadow: 0 0 8px var(--orange); animation: blink 0.5s infinite; }
        .status-led.off { background: var(--red); }
        
        .btn-open-proj { background: #333; color: white; border: 1px solid #555; font-size: 0.7rem; padding: 3px 8px; cursor: pointer; border-radius: 3px; }
        .btn-sync { background: #444; border: 1px solid #666; color: white; font-size: 0.7rem; cursor: pointer; padding: 3px 8px; border-radius: 3px; }
        .btn-sync:active { background: var(--accent); color: black; }

        .panel-memo { flex: 1; display: flex; flex-direction: column; min-height: 100px; }
        textarea#memo-pad { width: 100%; height: 100%; background: #111; border: 1px solid #333; color: #ddd; resize: none; padding: 8px; font-family: monospace; }
        
        @keyframes blink { 50% { opacity: 0.5; } }
        .conn-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; display: inline-block; }
        .conn-dot.connected { background: var(--green); }
        
        .key-hint { display: block; font-size: 0.6em; opacity: 0.6; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div class="main-grid">
        <div class="colonna-sx">
            <div class="panel">
                <h2>üëÅÔ∏è Monitor <div id="connStatus" class="conn-dot" title="Server"></div></h2>
                
                <div class="timer-box">
                    <div class="timer-display" id="timer">00:00</div>
                    <div>
                        <button onclick="timerStart()">‚ñ∂</button> 
                        <button onclick="timerStop()">‚è∏</button> 
                        <button onclick="timerReset()">‚Ü∫</button>
                    </div>
                </div>

                <div class="monitor-grid" id="monitor">
                    <div class="mini-slot" id="mon1">1</div>
                    <div class="mini-slot" id="mon2">2</div>
                    <div class="mini-slot" id="mon3">3</div>
                    <div class="mini-slot" id="mon4">4</div>
                </div>
                
                <button class="btn-reset-gara" onclick="resetGara()">üîÑ RESET VOTI (X)</button>
                <button class="btn-reset-totale" onclick="resetTotale()">‚ö†Ô∏è RESET TOTALE GIUDICI</button>
            </div>

            <div class="panel panel-playlist">
                <h2>üé§ Scaletta</h2>
                <div class="playlist-container" id="lista-bottoni"></div>
            </div>
        </div>

        <div class="colonna-dx">
            <div class="panel">
                <h2>üéõÔ∏è Audio</h2>
                <div class="audio-grid">
                    <button id="btn-sigla" class="btn-sound bg-blue" onclick="toggleMusic('sigla')"><span class="key-hint">[Q]</span>SIGLA</button>
                    <button id="btn-entrata" class="btn-sound bg-pink" onclick="toggleMusic('entrata')"><span class="key-hint">[S]</span>ENTRATA</button>
                    <button id="btn-sottofondo" class="btn-sound bg-purple" onclick="toggleMusic('sottofondo')"><span class="key-hint">[W]</span>SOTTOF.</button>
                    
                    <button id="btn-suspense" class="btn-sound bg-orange" onclick="toggleMusic('suspense')"><span class="key-hint">[E]</span>SUSPENSE</button>
                    <button id="btn-vittoria" class="btn-sound bg-green" onclick="toggleMusic('vittoria')"><span class="key-hint">[R]</span>VITTORIA</button>
                    <button id="btn-alessandro" class="btn-sound bg-teal" onclick="toggleMusic('alessandro')"><span class="key-hint">[A]</span>ALE</button>
                </div>
                
                <div class="sfx-grid">
                    <button id="btn-applausi" class="btn-sfx" onclick="toggleSfx('applausi')"><span class="key-hint">[1]</span> üëè CLAP</button>
                    <button id="btn-buu" class="btn-sfx" onclick="toggleSfx('buu')"><span class="key-hint">[2]</span> üëé BUU</button>
                    <button id="btn-rullo" class="btn-sfx" onclick="toggleSfx('rullo')"><span class="key-hint">[3]</span> ü•Å RULLO</button>
                    <button id="btn-grillo" class="btn-sfx" onclick="toggleSfx('grillo')"><span class="key-hint">[4]</span> ü¶ó GRILLO</button>
                </div>
                
                <div class="pro-controls">
                    <button id="btn-talkover" class="btn-talkover" onmousedown="setTalkover(true)" onmouseup="setTalkover(false)">üé§ TALK [T]</button>
                    <button class="btn-panic" onclick="panicMode()">üõë PANIC [ESC]</button>
                </div>
                
                <div class="mixer-container">
                    <div><small>MUSIC</small><input type="range" id="volMusic" min="0" max="1" step="0.05" value="0.7" oninput="updateMusicVolume(this.value)"></div>
                    <div><small>SFX</small><input type="range" id="volSfx" min="0" max="1" step="0.05" value="1.0" oninput="updateSfxVolume(this.value)"></div>
                </div>
            </div>

            <div class="right-bottom-container">
                <div class="panel panel-player">
                    <h2>üì∫ Player Master (Confidence)</h2>
                    
                    <div class="projector-status-bar">
                        <div><span id="proj-led" class="status-led off"></span> <span id="proj-text" style="font-size:0.8rem; color:#888">OFFLINE</span></div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-sync" onclick="forceResync()">‚ö° FORZA SYNC</button>
                            <button class="btn-open-proj" onclick="openProjector()">üì∫ POPUP</button>
                        </div>
                    </div>

                    <div id="videoContainer" class="video-wrapper">
                        <div id="player"></div>
                    </div>
                </div>
                <div class="panel panel-memo">
                    <textarea id="memo-pad" placeholder="Note..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <audio id="track-sigla" src="sigla.mp3" loop preload="auto"></audio>
    <audio id="track-entrata" src="entrata.mp3" loop preload="auto"></audio> <audio id="track-sottofondo" src="sottofondo.mp3" loop preload="auto"></audio>
    <audio id="track-suspense" src="suspense.mp3" loop preload="auto"></audio>
    <audio id="track-vittoria" src="vittoria.mp3" preload="auto"></audio> 
    <audio id="track-alessandro" src="alessandro.mp3" loop preload="auto"></audio>
    <audio id="fx-vai" src="vai.mp3" preload="auto"></audio>
    <audio id="sfx-applausi" src="applausi.mp3" preload="auto"></audio>
    <audio id="sfx-buu" src="buu.mp3" preload="auto"></audio>
    <audio id="sfx-rullo" src="rullo.mp3" preload="auto"></audio>
    <audio id="sfx-grillo" src="grillo.mp3" preload="auto"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const playlist = [
            { nome: "1. A Natale Puoi", id: "IIIGrh2IW70" }, { nome: "2. Piccoli aiutanti di BN", id: "yogiJpFmuAA" },
            { nome: "3. Tunak Tunak Star Trek", id: "viMEhOWcxd0" }, { nome: "4. Chiara gemma", id: "dSWhxDeMJaA" },
            { nome: "5. Le pizzicate", id: "HkojXZkXATw" }, { nome: "6. Sofia Barba", id: "fQ7Bt10jUfM" },
            { nome: "7. Giacomo Stursi", id: "eWTgTeedLCM" }, { nome: "8. The Little Mix", id: "1mAwbK9IN0g" },
            { nome: "9. Alessandro e animatori", id: "TJCXKII26rg" }, { nome: "10. Antonio Botrugno", id: "GCR5ujxheQg" },
            { nome: "11. Summer Girls 2010", id: "czWcyZRAMtk" }, { nome: "12. Emily Tudisco", id: "YQsjQiq2-VM" },
            { nome: "13. Francesco Vantaggiato", id: "" }, { nome: "14. Stecchini Duo", id: "wOxgZCoXRiQ" },
            { nome: "15. Judo Giuri", id: "hKRUPYrAQoE" }, { nome: "16. Anna Marti", id: "Kwx-3ihxiCQ" }
        ];

        const listContainer = document.getElementById('lista-bottoni');
        playlist.forEach((item, index) => {
            const btn = document.createElement('button');
            btn.className = 'btn-concorrente';
            btn.innerText = item.nome;
            btn.onclick = () => loadVideo(index);
            btn.id = `btn-c-${index}`;
            listContainer.appendChild(btn);
        });

        // AUDIO ENGINE AGGIORNATO
        const tracks = { 
            sigla: document.getElementById('track-sigla'), 
            entrata: document.getElementById('track-entrata'), // NUOVO
            sottofondo: document.getElementById('track-sottofondo'), 
            suspense: document.getElementById('track-suspense'), 
            vittoria: document.getElementById('track-vittoria'), 
            alessandro: document.getElementById('track-alessandro') 
        };
        const instantSfx = { applausi: document.getElementById('sfx-applausi'), buu: document.getElementById('sfx-buu'), rullo: document.getElementById('sfx-rullo'), grillo: document.getElementById('sfx-grillo') };
        const sfxVai = document.getElementById('fx-vai');
        let musicVolume = 0.7, sfxVolume = 1.0, isTalkover = false, fadeIntervals = {};

        Object.keys(instantSfx).forEach(name => {
            instantSfx[name].addEventListener('ended', () => document.getElementById(`btn-${name}`).classList.remove('playing'));
        });

        function fadeAudio(audio, targetVol, duration, callback) {
            const id = audio.id;
            if (fadeIntervals[id]) clearInterval(fadeIntervals[id]);
            if (targetVol > 0 && audio.paused) { audio.volume = 0; audio.play(); }
            const steps = duration / 20; const volStep = (targetVol - audio.volume) / steps;
            fadeIntervals[id] = setInterval(() => {
                let newVol = audio.volume + volStep;
                if ((volStep > 0 && newVol >= targetVol) || (volStep < 0 && newVol <= targetVol)) {
                    audio.volume = targetVol; clearInterval(fadeIntervals[id]);
                    if (targetVol <= 0.01) { audio.pause(); audio.currentTime = 0; }
                    if (callback) callback();
                } else audio.volume = newVol;
            }, 20);
        }

        function toggleMusic(name) {
            const t = tracks[name]; const btn = document.getElementById(`btn-${name}`);
            if(!t.paused) { t.volume=0; t.pause(); t.currentTime=0; btn.classList.remove('playing'); }
            else { 
                Object.values(tracks).forEach(x=>{x.pause(); x.currentTime=0;}); 
                document.querySelectorAll('.audio-grid .btn-sound').forEach(b=>b.classList.remove('playing'));
                if(localPlayer && typeof localPlayer.pauseVideo === 'function') localPlayer.pauseVideo();
                t.volume=0.7; t.play(); btn.classList.add('playing'); 
            }
        }
        function toggleSfx(name) { sfx[name].currentTime=0; sfx[name].play(); }
        function setTalkover(active) { Object.values(tracks).forEach(t => { if(!t.paused) t.volume = active ? 0.2 : 0.7; }); document.getElementById('btn-talkover').classList.toggle('active', active); }
        
        function updateMusicVolume(v) { musicVolume = parseFloat(v); Object.values(tracks).forEach(t => { if(!t.paused) t.volume = isTalkover ? musicVolume*0.2 : musicVolume; }); }
        function updateSfxVolume(v) { sfxVolume = parseFloat(v); Object.values(instantSfx).forEach(s => s.volume = sfxVolume); sfxVai.volume = sfxVolume; }

        function panicMode() {
            if(localPlayer) localPlayer.stopVideo();
            sendRemote('stop');
            socket.emit('controllo-video', 'stop'); 
            Object.values(tracks).concat(Object.values(instantSfx)).concat([sfxVai]).forEach(a => { a.pause(); a.currentTime=0; });
            document.querySelectorAll('.playing').forEach(b => b.classList.remove('playing'));
        }

        let tInt, tSec = 0; const tDisp = document.getElementById('timer');
        function uT() { tDisp.innerText = `${Math.floor(tSec/60).toString().padStart(2,'0')}:${(tSec%60).toString().padStart(2,'0')}`; }
        function timerStart() { if(!tInt) tInt = setInterval(() => { tSec++; uT(); }, 1000); }
        function timerStop() { clearInterval(tInt); tInt = null; }
        function timerReset() { timerStop(); tSec = 0; uT(); }

        const memo = document.getElementById('memo-pad');
        if(localStorage.getItem('rM')) memo.value = localStorage.getItem('rM');
        memo.addEventListener('input', () => localStorage.setItem('rM', memo.value));

        document.addEventListener('keydown', (e) => {
            if(e.target.tagName === 'TEXTAREA') return;
            const k = e.key.toLowerCase();
            if(e.code === 'Space' || e.code === 'Escape') { e.preventDefault(); panicMode(); return; }
            if(k === 't' && !e.repeat) setTalkover(true);
            const map = {'q':'sigla', 's':'entrata', 'w':'sottofondo', 'e':'suspense', 'r':'vittoria', 'a':'alessandro', '1':'applausi', '2':'buu', '3':'rullo', '4':'grillo'};
            if(map[k]) { if('1234'.includes(k)) toggleSfx(map[k]); else toggleMusic(map[k]); }
        });
        document.addEventListener('keyup', (e) => { if(e.key.toLowerCase() === 't') setTalkover(false); });

        let localPlayer, remoteWindow, syncInt;

        function onYouTubeIframeAPIReady() {
            localPlayer = new YT.Player('player', { height: '100%', width: '100%', videoId: '',
                playerVars: { 'playsinline': 1, 'rel': 0, 'origin': window.location.origin },
                events: { 'onReady': e => { e.target.unMute(); e.target.setVolume(100); }, 'onStateChange': onStateChange }
            });
        }
        function onStateChange(e) {
            let cmd = null;
            if(e.data === 1) { cmd = 'play'; startSync(); } 
            if(e.data === 2) { cmd = 'pause'; stopSync(); } 
            if(e.data === 0) { cmd = 'stop'; stopSync(); } 
            if(cmd) { sendRemote(cmd); socket.emit('controllo-video', cmd); }
        }
        function sendRemote(act, par) { if(remoteWindow && !remoteWindow.closed) remoteWindow.postMessage({action:act, param:par}, '*'); }
        
        function loadVideo(index) {
            document.querySelectorAll('.btn-concorrente').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-c-${index}`).classList.add('active');
            socket.emit('set-concorrente', { nome: playlist[index].nome, id: playlist[index].id });
            if(playlist[index].id) {
                if(localPlayer) localPlayer.loadVideoById(playlist[index].id);
                sendRemote('load', playlist[index].id);
                Object.values(tracks).forEach(t => { t.pause(); t.currentTime=0; });
                document.querySelectorAll('.btn-sound').forEach(b => b.classList.remove('playing'));
            } else { alert("Nessun Video"); }
        }

        function openProjector() {
            remoteWindow = window.open("", "Proiettore", "width=800,height=600,menubar=no,toolbar=no");
            if(!remoteWindow) return alert("Sblocca Popup!");
            remoteWindow.document.write(`<html><body style="margin:0;background:black;overflow:hidden;"><div id="p" style="width:100vw;height:100vh;"></div><script src="https://www.youtube.com/iframe_api"><\/script><script>var p; function onYouTubeIframeAPIReady(){p=new YT.Player('p',{width:'100%',height:'100%',videoId:'',playerVars:{'controls':0,'disablekb':1},events:{'onReady':e=>{e.target.mute();window.opener.postMessage('READY','*');}}});} window.addEventListener('message',e=>{if(!p)return; if(e.data.action==='load')p.loadVideoById(e.data.param); if(e.data.action==='play')p.playVideo(); if(e.data.action==='pause')p.pauseVideo(); if(e.data.action==='stop')p.stopVideo(); if(e.data.action==='seek')p.seekTo(e.data.param); if(e.data.action==='getTime')window.opener.postMessage({type:'SYNC',t:p.getCurrentTime()},'*');});<\/script></body></html>`);
        }

        function startSync() { if(syncInt) clearInterval(syncInt); syncInt = setInterval(() => { if(remoteWindow) remoteWindow.postMessage({action:'getTime'}, '*'); }, 500); }
        function stopSync() { clearInterval(syncInt); document.getElementById('proj-led').className = 'status-led on'; }
        function forceResync() { if(localPlayer) sendRemote('seek', localPlayer.getCurrentTime()); }

        window.addEventListener('message', e => {
            if(e.data === 'READY') { document.getElementById('proj-led').className='status-led on'; document.getElementById('proj-text').innerText="PRONTO"; }
            if(e.data.type === 'SYNC' && localPlayer) {
                if(Math.abs(localPlayer.getCurrentTime() - e.data.t) > 0.3) {
                    document.getElementById('proj-led').className='status-led syncing';
                    sendRemote('seek', localPlayer.getCurrentTime());
                } else document.getElementById('proj-led').className='status-led on';
            }
        });

        const socket = io();
        socket.on('connect', () => document.getElementById('connStatus').classList.add('connected'));
        socket.on('aggiorna', s => {
            for(let i=1; i<=4; i++) {
                const el = document.getElementById(`mon${i}`);
                if(s[i].nome) { el.innerHTML = s[i].nome; el.classList.toggle('attivo', s[i].scelta==='X'); }
                else { el.innerHTML = i; el.classList.remove('attivo'); }
            }
        });
        socket.on('suono', x => { if(x==='X') { sfxVai.currentTime=0; sfxVai.play(); } });
        function resetGara() { socket.emit('reset'); if(!tracks.suspense.paused) toggleMusic('suspense'); }
        function resetTotale() { if(confirm("Reset Totale?")) socket.emit('reset-giudici'); }
    </script>
</body>
</html>

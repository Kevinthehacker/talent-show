<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Regia - Oratorio's Got Talent</title>
    <style>
        :root { --dark: #1a1a1a; --panel: #2d2d2d; --accent: #ffd700; --red: #e53935; --green: #43a047; }
        body { background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; height: 100vh; margin: 0; box-sizing: border-box; }
        
        h2 { border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-top: 0; }
        
        /* Pannelli */
        .panel { background: var(--panel); padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        /* Monitor Giudici (Miniatura) */
        .monitor-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .mini-slot { background: #000; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #444; }
        .mini-slot.attivo { background: #500; border-color: var(--red); }
        .status-dot { height: 15px; width: 15px; background: #333; border-radius: 50%; display: inline-block; margin-left: 10px; }
        .status-dot.on { background: var(--red); box-shadow: 0 0 10px var(--red); }

        /* Audio Console */
        .audio-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .btn-sound { border: none; padding: 20px; font-size: 1.2em; font-weight: bold; color: white; border-radius: 10px; cursor: pointer; transition: transform 0.1s; position: relative; overflow: hidden; }
        .btn-sound:active { transform: scale(0.95); }
        
        /* Colori Bottoni */
        .bg-blue { background: #1976d2; }   /* Sigla */
        .bg-cyan { background: #00acc1; }   /* Entrata (NUOVO) */
        .bg-purple { background: #7b1fa2; } /* Sottofondo */
        .bg-orange { background: #f57c00; } /* Suspense */
        .bg-green { background: var(--green); } /* Vittoria */
        .bg-red { background: var(--red); }     /* Reset */

        /* Fader Volume */
        .fader-group { margin-top: 20px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; }
        input[type=range] { width: 60%; cursor: pointer; }
        
        /* Indicatore riproduzione */
        .playing-indicator { position: absolute; top: 5px; right: 5px; font-size: 0.8em; opacity: 0; }
        .playing .playing-indicator { opacity: 1; animation: blink 1s infinite; }
        
        @keyframes blink { 50% { opacity: 0.3; } }
    </style>
</head>
<body>

    <div class="panel">
        <h2>üëÅÔ∏è Monitor Live</h2>
        <div class="monitor-grid" id="monitor">
            <div class="mini-slot" id="mon1">Slot 1 <span class="status-dot"></span></div>
            <div class="mini-slot" id="mon2">Slot 2 <span class="status-dot"></span></div>
            <div class="mini-slot" id="mon3">Slot 3 <span class="status-dot"></span></div>
            <div class="mini-slot" id="mon4">Slot 4 <span class="status-dot"></span></div>
        </div>

        <div style="margin-top: 30px;">
            <h2>‚öôÔ∏è Gestione</h2>
            <button onclick="resetGara()" class="btn-sound bg-red" style="width:100%">üîÑ NUOVO CONCORRENTE (Reset X)</button>
            <br><br>
            <button onclick="resetTotale()" style="background:#444; color:#ccc; border:none; padding:10px; width:100%; border-radius:5px;">‚ö†Ô∏è Reset Totale Giudici</button>
        </div>
    </div>

    <div class="panel">
        <h2>üéõÔ∏è Audio Console</h2>
        
        <div class="audio-grid">
            <button class="btn-sound bg-blue" onclick="toggleAudio('sigla')">
                üéµ SIGLA
                <span class="playing-indicator">‚ñ∂</span>
            </button>
            
            <button class="btn-sound bg-cyan" onclick="toggleAudio('entrata')">
                üö™ ENTRATA
                <span class="playing-indicator">‚ñ∂</span>
            </button>

            <button class="btn-sound bg-purple" onclick="toggleAudio('sottofondo')">
                üç∏ SOTTOFONDO
                <span class="playing-indicator">‚ñ∂</span>
            </button>

            <button class="btn-sound bg-orange" onclick="toggleAudio('suspense')">
                üò¨ SUSPENSE
                <span class="playing-indicator">‚ñ∂</span>
            </button>

            <button class="btn-sound bg-green" style="grid-column: span 2;" onclick="playEffect('vittoria')">
                üèÜ VITTORIA / PASSAGGIO TURNO
            </button>
        </div>

        <div class="fader-group">
            <span>Vol. Musica</span>
            <input type="range" id="volMusic" min="0" max="1" step="0.1" value="0.5" oninput="setVolume('music', this.value)">
        </div>
        <div class="fader-group">
            <span>Vol. Effetti</span>
            <input type="range" id="volSfx" min="0" max="1" step="0.1" value="1" oninput="setVolume('sfx', this.value)">
        </div>

        <div style="margin-top:20px; font-size:0.8em; color:#888;">
            *Clicca sui pulsanti colorati per avviare/stoppare il loop.
        </div>
    </div>

    <audio id="track-sigla" src="sigla.mp3" loop></audio>
    <audio id="track-entrata" src="entrata.mp3" loop></audio> <audio id="track-sottofondo" src="sottofondo.mp3" loop></audio>
    <audio id="track-suspense" src="suspense.mp3" loop></audio>
    <audio id="fx-vittoria" src="vittoria.mp3"></audio>
    <audio id="fx-vai" src="vai.mp3"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        // --- CONFIGURAZIONE FADE ---
        const FADE_DURATION = 2000; // Durata dissolvenza in millisecondi (2 secondi)
        let activeIntervals = {}; // Per memorizzare gli intervalli di fade e non sovrapporli

        // --- GESTIONE AUDIO ---
        const tracks = {
            sigla: document.getElementById('track-sigla'),
            entrata: document.getElementById('track-entrata'),
            sottofondo: document.getElementById('track-sottofondo'),
            suspense: document.getElementById('track-suspense')
        };
        const sfx = {
            vittoria: document.getElementById('fx-vittoria'),
            vai: document.getElementById('fx-vai')
        };

        // Valori volume correnti (dal cursore)
        let currentMusicVol = 0.5;
        let currentSfxVol = 1.0;

        // FUNZIONE "MAGICA" PER IL FADE
        function fadeAudio(audio, targetVol, duration, callback) {
            // Se c'√® gi√† un fade in corso su questa traccia, cancellalo
            if (activeIntervals[audio.id]) clearInterval(activeIntervals[audio.id]);

            const stepTime = 50; // Aggiorna ogni 50ms
            const steps = duration / stepTime;
            const volStep = (targetVol - audio.volume) / steps;
            
            // Se stiamo alzando il volume, assicuriamoci che l'audio stia suonando
            if (targetVol > 0 && audio.paused) {
                audio.play();
            }

            activeIntervals[audio.id] = setInterval(() => {
                let newVol = audio.volume + volStep;

                // Controlli per non sforare (clamping)
                if (volStep > 0 && newVol >= targetVol) newVol = targetVol;
                if (volStep < 0 && newVol <= 0) newVol = 0;

                audio.volume = newVol;

                // Fine del fade
                if (newVol === targetVol) {
                    clearInterval(activeIntervals[audio.id]);
                    delete activeIntervals[audio.id];
                    
                    // Se il target era 0 (fade out), mettiamo in pausa e resettiamo
                    if (targetVol === 0) {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                    
                    if (callback) callback();
                }
            }, stepTime);
        }

        // GESTIONE PLAY/STOP CON FADE
        function toggleAudio(name) {
            const audio = tracks[name];
            const btn = document.querySelector(`button[onclick="toggleAudio('${name}')"]`);
            
            // 1. Ferma (sfumando) tutte le altre tracce attive
            Object.keys(tracks).forEach(k => {
                if (k !== name) {
                    const otherAudio = tracks[k];
                    const otherBtn = document.querySelector(`button[onclick="toggleAudio('${k}')"]`);
                    
                    if (!otherAudio.paused && otherAudio.volume > 0) {
                        // Fade Out rapido per le altre tracce
                        fadeAudio(otherAudio, 0, 1500); 
                        if(otherBtn) otherBtn.classList.remove('playing');
                    }
                }
            });

            // 2. Gestisci la traccia cliccata
            if (audio.paused || audio.volume === 0) {
                // START: Imposta volume a 0 e fai Fade In
                audio.volume = 0;
                fadeAudio(audio, currentMusicVol, FADE_DURATION);
                btn.classList.add('playing');
            } else {
                // STOP: Fai Fade Out a 0
                fadeAudio(audio, 0, 1500, () => {
                    // Callback opzionale a fine fade out
                });
                btn.classList.remove('playing');
            }
        }

        // GESTIONE EFFETTI SINGOLI (Jingle) - Niente fade, devono essere immediati
        function playEffect(name) {
            // Opzionale: abbassa leggermente la musica di sottofondo mentre suona l'effetto?
            // Per ora lo lasciamo semplice: suona sopra.
            sfx[name].volume = currentSfxVol;
            sfx[name].currentTime = 0;
            sfx[name].play();
        }

        // CONTROLLO SLIDER VOLUME
        function setVolume(type, val) {
            const numericVal = parseFloat(val);
            if (type === 'music') {
                currentMusicVol = numericVal;
                // Aggiorna volume solo delle tracce che stanno suonando (non quelle in fade out/stop)
                Object.values(tracks).forEach(t => {
                    if (!t.paused && t.volume > 0 && !activeIntervals[t.id]) {
                        t.volume = currentMusicVol;
                    }
                });
            } else {
                currentSfxVol = numericVal;
                Object.values(sfx).forEach(s => s.volume = currentSfxVol);
            }
        }
        
        // Inizializza volumi
        document.getElementById('volMusic').value = 0.5;
        document.getElementById('volSfx').value = 1.0;


        // --- GESTIONE SOCKET (Monitoraggio) ---
        socket.on('aggiorna', (stato) => {
            for (let i = 1; i <= 4; i++) {
                const slot = stato[i];
                const el = document.getElementById(`mon${i}`);
                
                if (slot.nome) {
                    el.innerHTML = `${slot.nome} <span class="status-dot"></span>`;
                    if (slot.scelta === 'X') {
                        el.querySelector('.status-dot').classList.add('on');
                        el.classList.add('attivo');
                    } else {
                        el.querySelector('.status-dot').classList.remove('on');
                        el.classList.remove('attivo');
                    }
                } else {
                    el.innerHTML = `Slot ${i} (Vuoto) <span class="status-dot"></span>`;
                }
            }
        });

        socket.on('suono', (scelta) => {
            if (scelta === 'X') {
                sfx.vai.volume = currentSfxVol;
                sfx.vai.play();
            }
        });

        function resetGara() {
            socket.emit('reset');
            // Se c'√® suspense attiva, sfumala via
            const suspenseTrack = tracks['suspense'];
            if (!suspenseTrack.paused) {
                toggleAudio('suspense'); // Questo attiver√† il fade out automatico
            }
        }
        
        function resetTotale() {
            if(confirm("Vuoi scollegare tutti i giudici?")) socket.emit('reset-giudici');
        }
    </script>
</body>
</html>

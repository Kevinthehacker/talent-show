<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Regia OGT - FULL SYNC</title>
    <style>
        :root { 
            --dark: #121212; --panel: #1e1e1e; --accent: #ffd700; 
            --red: #d32f2f; --green: #00e676; --blue: #1976d2;
            --purple: #7b1fa2; --orange: #f57c00; --teal: #009688;
        }
        body { background: var(--dark); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; height: 100vh; overflow: hidden; user-select: none; }
        .main-grid { display: grid; grid-template-columns: 340px 1fr; gap: 10px; height: 100%; }
        .colonna-sx { display: flex; flex-direction: column; gap: 10px; height: 100%; overflow-y: auto; padding-right: 5px; min-height: 0; }
        .colonna-dx { display: flex; flex-direction: column; gap: 10px; height: 100%; min-height: 0; }
        .panel { background: var(--panel); padding: 12px; border-radius: 8px; border: 1px solid #333; flex-shrink: 0; }
        h2 { border-bottom: 1px solid #444; padding-bottom: 5px; margin: 0 0 8px 0; font-size: 0.95rem; color: var(--accent); display: flex; justify-content: space-between; }
        
        .monitor-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; margin-bottom: 8px; }
        .mini-slot { background: #000; padding: 5px; border-radius: 4px; text-align: center; border: 1px solid #333; font-size: 0.8rem; color: #666; }
        .mini-slot.attivo { background: #3c0b0b; border-color: var(--red); color: white; font-weight: bold; }
        .btn-reset-gara { width: 100%; padding: 10px; background: var(--red); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-reset-totale { width: 100%; padding: 8px; background: #333; color: #aaa; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-top: 5px; }
        
        .playlist-container { flex-grow: 1; overflow-y: auto; }
        .btn-concorrente { width: 100%; text-align: left; padding: 8px; margin-bottom: 3px; background: #2a2a2a; color: #ccc; border: none; border-left: 3px solid transparent; cursor: pointer; }
        .btn-concorrente.active { background: #333; color: var(--accent); border-left: 3px solid var(--accent); font-weight: bold; }
        
        .audio-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
        .btn-sound { border: none; padding: 10px 2px; font-size: 0.65rem; font-weight: bold; color: white; border-radius: 4px; cursor: pointer; position: relative; }
        .btn-sound.playing { box-shadow: inset 0 0 0 2px white; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        .bg-blue { background: var(--blue); } .bg-purple { background: var(--purple); } .bg-orange { background: var(--orange); } .bg-green { background: var(--green); } .bg-teal { background: var(--teal); }
        
        .sfx-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 5px; }
        .btn-sfx { background: #37474f; color: #eceff1; padding: 8px 2px; font-size: 0.7rem; cursor: pointer; border: 1px solid #546e7a; border-radius: 4px; }
        .btn-sfx:active { transform: scale(0.95); }
        
        .pro-controls { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-talkover { background: #ff9800; color: black; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; }
        .btn-talkover.active { background: var(--accent); }
        .btn-panic { background: #b71c1c; color: white; font-weight: bold; border: 1px solid red; border-radius: 4px; cursor: pointer; }
        
        .right-bottom-container { flex-grow: 1; display: flex; flex-direction: column; gap: 10px; min-height: 0; }
        .panel-player { flex: 2; display: flex; flex-direction: column; min-height: 0; padding-bottom: 5px; }
        .video-wrapper { flex-grow: 1; width: 100%; background: black; border-radius: 6px; overflow: hidden; position: relative; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        .projector-status-bar { display: flex; justify-content: space-between; align-items: center; background: #000; padding: 5px 10px; border-radius: 4px; margin-bottom: 5px; border: 1px solid #333; }
        .status-led { width: 12px; height: 12px; border-radius: 50%; background: #333; display: inline-block; margin-right: 5px; }
        .status-led.on { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .status-led.syncing { background: var(--orange); animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        
        .btn-open-proj { background: #333; color: white; border: 1px solid #555; font-size: 0.7rem; padding: 3px 8px; cursor: pointer; border-radius: 3px; }
        .btn-sync { background: #444; border: 1px solid #666; color: white; font-size: 0.7rem; cursor: pointer; padding: 3px 8px; border-radius: 3px; }
        .btn-sync:active { background: var(--accent); color: black; }

        .panel-memo { flex: 1; display: flex; flex-direction: column; min-height: 100px; }
        textarea#memo-pad { width: 100%; height: 100%; background: #111; border: 1px solid #333; color: #ddd; resize: none; padding: 8px; font-family: monospace; }
        .conn-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; display: inline-block; }
        .conn-dot.connected { background: var(--green); }
    </style>
</head>
<body>
    <div class="main-grid">
        <div class="colonna-sx">
            <div class="panel">
                <h2>üëÅÔ∏è Monitor <div id="connStatus" class="conn-dot"></div></h2>
                <div class="monitor-grid" id="monitor">
                    <div class="mini-slot" id="mon1">1</div><div class="mini-slot" id="mon2">2</div>
                    <div class="mini-slot" id="mon3">3</div><div class="mini-slot" id="mon4">4</div>
                </div>
                <button class="btn-reset-gara" onclick="resetGara()">üîÑ RESET X</button>
                <button class="btn-reset-totale" onclick="resetTotale()">‚ö†Ô∏è RESET TOTALE</button>
            </div>
            <div class="panel panel-playlist">
                <h2>üé§ Scaletta</h2>
                <div class="playlist-container" id="lista-bottoni"></div>
            </div>
        </div>
        <div class="colonna-dx">
            <div class="panel">
                <h2>üéõÔ∏è Audio</h2>
                <div class="audio-grid">
                    <button id="btn-sigla" class="btn-sound bg-blue" onclick="toggleMusic('sigla')">SIGLA</button>
                    <button id="btn-sottofondo" class="btn-sound bg-purple" onclick="toggleMusic('sottofondo')">SOTTOF.</button>
                    <button id="btn-suspense" class="btn-sound bg-orange" onclick="toggleMusic('suspense')">SUSPENSE</button>
                    <button id="btn-vittoria" class="btn-sound bg-green" onclick="toggleMusic('vittoria')">VITTORIA</button>
                    <button id="btn-alessandro" class="btn-sound bg-teal" onclick="toggleMusic('alessandro')">ALE</button>
                </div>
                <div class="sfx-grid">
                    <button id="btn-applausi" class="btn-sfx" onclick="toggleSfx('applausi')">üëè CLAP</button>
                    <button id="btn-buu" class="btn-sfx" onclick="toggleSfx('buu')">üëé BUU</button>
                    <button id="btn-rullo" class="btn-sfx" onclick="toggleSfx('rullo')">ü•Å RULLO</button>
                    <button id="btn-grillo" class="btn-sfx" onclick="toggleSfx('grillo')">ü¶ó GRILLO</button>
                </div>
                <div class="pro-controls">
                    <button id="btn-talkover" class="btn-talkover" onmousedown="setTalkover(true)" onmouseup="setTalkover(false)">üé§ TALK</button>
                    <button class="btn-panic" onclick="panicMode()">üõë PANIC</button>
                </div>
            </div>
            <div class="right-bottom-container">
                <div class="panel panel-player">
                    <h2>üì∫ Player Master</h2>
                    <div class="projector-status-bar">
                        <div><span id="proj-led" class="status-led"></span> <span id="proj-text" style="font-size:0.8rem; color:#888">OFFLINE</span></div>
                        <div>
                            <button class="btn-open-proj" onclick="forceResync()">‚ö° SYNC</button>
                            <button class="btn-open-proj" onclick="openProjector()">üì∫ POPUP</button>
                        </div>
                    </div>
                    <div class="video-wrapper"><div id="player"></div></div>
                </div>
            </div>
        </div>
    </div>

    <audio id="track-sigla" src="sigla.mp3" loop preload="auto"></audio>
    <audio id="track-sottofondo" src="sottofondo.mp3" loop preload="auto"></audio>
    <audio id="track-suspense" src="suspense.mp3" loop preload="auto"></audio>
    <audio id="track-vittoria" src="vittoria.mp3" preload="auto"></audio> 
    <audio id="track-alessandro" src="alessandro.mp3" loop preload="auto"></audio>
    <audio id="fx-vai" src="vai.mp3" preload="auto"></audio>
    <audio id="sfx-applausi" src="applausi.mp3" preload="auto"></audio>
    <audio id="sfx-buu" src="buu.mp3" preload="auto"></audio>
    <audio id="sfx-rullo" src="rullo.mp3" preload="auto"></audio>
    <audio id="sfx-grillo" src="grillo.mp3" preload="auto"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const playlist = [
            { nome: "1. A Natale Puoi", id: "IIIGrh2IW70" }, { nome: "2. Piccoli aiutanti di BN", id: "yogiJpFmuAA" },
            { nome: "3. Tunak Tunak Star Trek", id: "viMEhOWcxd0" }, { nome: "4. Chiara gemma", id: "dSWhxDeMJaA" },
            { nome: "5. Le pizzicate", id: "HkojXZkXATw" }, { nome: "6. Sofia Barba", id: "fQ7Bt10jUfM" },
            { nome: "7. Giacomo Stursi", id: "eWTgTeedLCM" }, { nome: "8. The Little Mix", id: "1mAwbK9IN0g" },
            { nome: "9. Alessandro e animatori", id: "TJCXKII26rg" }, { nome: "10. Antonio Botrugno", id: "GCR5ujxheQg" },
            { nome: "11. Summer Girls 2010", id: "czWcyZRAMtk" }, { nome: "12. Emily Tudisco", id: "YQsjQiq2-VM" },
            { nome: "13. Francesco Vantaggiato", id: "" }, { nome: "14. Stecchini Duo", id: "wOxgZCoXRiQ" },
            { nome: "15. Judo Giuri", id: "hKRUPYrAQoE" }, { nome: "16. Anna Marti", id: "Kwx-3ihxiCQ" }
        ];

        const listContainer = document.getElementById('lista-bottoni');
        playlist.forEach((item, index) => {
            const btn = document.createElement('button');
            btn.className = 'btn-concorrente';
            btn.innerText = item.nome;
            btn.onclick = () => loadVideo(index);
            btn.id = `btn-c-${index}`;
            listContainer.appendChild(btn);
        });

        const tracks = { sigla: document.getElementById('track-sigla'), sottofondo: document.getElementById('track-sottofondo'), suspense: document.getElementById('track-suspense'), vittoria: document.getElementById('track-vittoria'), alessandro: document.getElementById('track-alessandro') };
        const sfx = { applausi: document.getElementById('sfx-applausi'), buu: document.getElementById('sfx-buu'), rullo: document.getElementById('sfx-rullo'), grillo: document.getElementById('sfx-grillo') };
        const sfxVai = document.getElementById('fx-vai');
        let fadeInt, localPlayer, remoteWindow, syncInt;

        function toggleMusic(name) {
            const t = tracks[name]; const btn = document.getElementById(`btn-${name}`);
            if(!t.paused) { t.volume=0; t.pause(); t.currentTime=0; btn.classList.remove('playing'); }
            else { 
                Object.values(tracks).forEach(x=>{x.pause(); x.currentTime=0;}); 
                document.querySelectorAll('.btn-sound').forEach(b=>b.classList.remove('playing'));
                if(localPlayer && typeof localPlayer.pauseVideo === 'function') localPlayer.pauseVideo();
                t.volume=0.7; t.play(); btn.classList.add('playing'); 
            }
        }
        function toggleSfx(name) { sfx[name].currentTime=0; sfx[name].play(); }
        function setTalkover(active) { Object.values(tracks).forEach(t => { if(!t.paused) t.volume = active ? 0.2 : 0.7; }); document.getElementById('btn-talkover').classList.toggle('active', active); }
        
        function panicMode() {
            if(localPlayer) localPlayer.stopVideo();
            sendRemote('stop');
            // MANDA STOP AI TELEFONI
            socket.emit('controllo-video', 'stop'); 
            Object.values(tracks).concat(Object.values(sfx)).concat([sfxVai]).forEach(a => { a.pause(); a.currentTime=0; });
            document.querySelectorAll('.playing').forEach(b => b.classList.remove('playing'));
        }

        // VIDEO SYNC
        function onYouTubeIframeAPIReady() {
            localPlayer = new YT.Player('player', { height: '100%', width: '100%', videoId: '',
                playerVars: { 'playsinline': 1, 'rel': 0, 'origin': window.location.origin },
                events: { 'onReady': e => { e.target.unMute(); e.target.setVolume(100); }, 'onStateChange': onStateChange }
            });
        }
        
        // --- QUI AVVIENE LA MAGIA ---
        function onStateChange(e) {
            let cmd = null;
            if(e.data === 1) { cmd = 'play'; startSync(); } // 1 = Playing
            if(e.data === 2) { cmd = 'pause'; stopSync(); } // 2 = Paused
            if(e.data === 0) { cmd = 'stop'; stopSync(); } // 0 = Ended

            if(cmd) {
                // 1. Manda al Proiettore
                sendRemote(cmd);
                // 2. Manda ai Telefoni (NUOVO!)
                socket.emit('controllo-video', cmd);
            }
        }

        function sendRemote(act, par) { if(remoteWindow && !remoteWindow.closed) remoteWindow.postMessage({action:act, param:par}, '*'); }
        
        function loadVideo(index) {
            document.querySelectorAll('.btn-concorrente').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-c-${index}`).classList.add('active');
            
            // INVIO NOME E ID AL SERVER
            socket.emit('set-concorrente', { nome: playlist[index].nome, id: playlist[index].id });

            if(playlist[index].id) {
                if(localPlayer) localPlayer.loadVideoById(playlist[index].id);
                sendRemote('load', playlist[index].id);
                Object.values(tracks).forEach(t => { t.pause(); t.currentTime=0; });
                document.querySelectorAll('.btn-sound').forEach(b => b.classList.remove('playing'));
            } else { alert("Nessun Video"); }
        }

        function openProjector() {
            remoteWindow = window.open("", "Proiettore", "width=800,height=600,menubar=no,toolbar=no");
            if(!remoteWindow) return alert("Sblocca Popup!");
            remoteWindow.document.write(`<html><body style="margin:0;background:black;overflow:hidden;"><div id="p" style="width:100vw;height:100vh;"></div><script src="https://www.youtube.com/iframe_api"><\/script><script>var p; function onYouTubeIframeAPIReady(){p=new YT.Player('p',{width:'100%',height:'100%',videoId:'',playerVars:{'controls':0,'disablekb':1},events:{'onReady':e=>{e.target.mute();window.opener.postMessage('READY','*');}}});} window.addEventListener('message',e=>{if(!p)return; if(e.data.action==='load')p.loadVideoById(e.data.param); if(e.data.action==='play')p.playVideo(); if(e.data.action==='pause')p.pauseVideo(); if(e.data.action==='stop')p.stopVideo(); if(e.data.action==='seek')p.seekTo(e.data.param); if(e.data.action==='getTime')window.opener.postMessage({type:'SYNC',t:p.getCurrentTime()},'*');});<\/script></body></html>`);
        }

        // SYNC LOOP
        function startSync() {
            if(syncInt) clearInterval(syncInt);
            syncInt = setInterval(() => { if(remoteWindow) remoteWindow.postMessage({action:'getTime'}, '*'); }, 500);
        }
        function stopSync() { clearInterval(syncInt); document.getElementById('proj-led').className = 'status-led on'; }
        function forceResync() { if(localPlayer) sendRemote('seek', localPlayer.getCurrentTime()); }

        window.addEventListener('message', e => {
            if(e.data === 'READY') { document.getElementById('proj-led').className='status-led on'; document.getElementById('proj-text').innerText="PRONTO"; }
            if(e.data.type === 'SYNC' && localPlayer) {
                if(Math.abs(localPlayer.getCurrentTime() - e.data.t) > 0.3) {
                    document.getElementById('proj-led').className='status-led syncing';
                    sendRemote('seek', localPlayer.getCurrentTime());
                } else document.getElementById('proj-led').className='status-led on';
            }
        });

        // SOCKET
        const socket = io();
        socket.on('connect', () => document.getElementById('connStatus').classList.add('connected'));
        socket.on('aggiorna', s => {
            for(let i=1; i<=4; i++) {
                const el = document.getElementById(`mon${i}`);
                if(s[i].nome) { el.innerHTML = s[i].nome; el.classList.toggle('attivo', s[i].scelta==='X'); }
                else { el.innerHTML = i; el.classList.remove('attivo'); }
            }
        });
        socket.on('suono', x => { if(x==='X') { sfxVai.currentTime=0; sfxVai.play(); } });
        function resetGara() { socket.emit('reset'); if(!tracks.suspense.paused) toggleMusic('suspense'); }
        function resetTotale() { if(confirm("Reset Totale?")) socket.emit('reset-giudici'); }
    </script>
</body>
</html>

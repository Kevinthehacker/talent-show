<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Regia OGT - ULTIMATE</title>
    <style>
        :root { 
            --dark: #121212; 
            --panel: #1e1e1e; 
            --accent: #ffd700; 
            --red: #d32f2f; 
            --green: #388e3c;
            --blue: #1976d2;
            --purple: #7b1fa2;
            --orange: #f57c00;
            --teal: #009688;
            --text-gray: #b0b0b0;
        }
        
        body { 
            background: var(--dark); 
            color: white; 
            font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; 
            margin: 0; 
            padding: 10px;
            box-sizing: border-box; 
            height: 100vh; 
            overflow: hidden; 
            user-select: none; 
        }

        /* Layout Grid */
        .main-grid { display: grid; grid-template-columns: 340px 1fr; gap: 10px; height: 100%; }
        .colonna { display: flex; flex-direction: column; gap: 10px; height: 100%; min-height: 0; }
        .panel { background: var(--panel); padding: 12px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid #333; }
        
        h2 { 
            border-bottom: 1px solid #444; padding-bottom: 5px; margin-top: 0; margin-bottom: 8px;
            font-size: 0.95rem; text-transform: uppercase; letter-spacing: 1px; color: var(--accent);
            display: flex; justify-content: space-between; align-items: center;
        }
        .connection-status { width: 10px; height: 10px; border-radius: 50%; background: #444; display: inline-block; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .connection-status.connected { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .connection-status.disconnected { background: var(--red); box-shadow: 0 0 8px var(--red); animation: blinkRed 1s infinite; }
        @keyframes blinkRed { 50% { opacity: 0.3; } }

        h3 { font-size: 0.75rem; color: #888; margin: 8px 0 4px 0; text-transform: uppercase; }

        /* --- SINISTRA --- */
        .monitor-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; margin-bottom: 8px; }
        .mini-slot { background: #000; padding: 5px; border-radius: 4px; text-align: center; border: 1px solid #333; font-size: 0.8rem; color: #666; transition: 0.3s; }
        .mini-slot.attivo { background: #3c0b0b; border-color: var(--red); color: white; font-weight: bold; }
        
        .timer-box { background: black; border: 1px solid #444; border-radius: 6px; padding: 5px 10px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .timer-display { font-family: 'Courier New', monospace; font-size: 1.5rem; color: var(--accent); font-weight: bold; }
        .timer-controls button { background: #333; color: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8rem; margin-left: 2px; }
        .timer-controls button:hover { background: #555; }

        .btn-reset-gara { width: 100%; padding: 8px; background: var(--red); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.85rem; }
        .btn-reset-gara:hover { background: #b71c1c; }
        .btn-reset-totale { width: 100%; margin-top: 5px; padding: 4px; background: #333; color: #888; border: 1px solid #444; border-radius: 4px; cursor: pointer; font-size: 0.7rem; }

        .panel-playlist { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        .playlist-container { flex-grow: 1; overflow-y: auto; padding-right: 5px; scrollbar-width: thin; scrollbar-color: #444 #1e1e1e; }
        .btn-concorrente {
            width: 100%; text-align: left; padding: 8px 10px; margin-bottom: 3px;
            background: #2a2a2a; color: #ccc; border: none; border-left: 3px solid transparent;
            border-radius: 4px; cursor: pointer; transition: all 0.1s ease; font-size: 0.85rem; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-concorrente:hover { background: #333; color: white; padding-left: 12px; }
        .btn-concorrente.active { background: #333; color: var(--accent); border-left: 3px solid var(--accent); font-weight: bold; }

        /* --- DESTRA: AUDIO --- */
        /* Modificato a 5 colonne per far entrare Alessandro */
        .audio-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 5px; }
        
        .btn-sound { 
            border: none; padding: 10px 2px; font-size: 0.65rem; font-weight: bold; color: white; 
            border-radius: 5px; cursor: pointer; position: relative; overflow: hidden; transition: opacity 0.2s;
        }
        .btn-sound.playing { box-shadow: inset 0 0 0 2px white; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        
        .bg-blue { background: var(--blue); } 
        .bg-purple { background: var(--purple); } 
        .bg-orange { background: var(--orange); } 
        .bg-green { background: var(--green); }
        .bg-teal { background: var(--teal); }

        .sfx-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 10px; }
        .btn-sfx {
            background: #37474f; color: #eceff1; border: 1px solid #546e7a;
            padding: 8px 2px; font-size: 0.7rem; border-radius: 5px; cursor: pointer; transition: background 0.1s;
        }
        .btn-sfx:active { transform: scale(0.95); }
        .btn-sfx.playing { box-shadow: inset 0 0 0 2px var(--accent); background: #455a64; color: var(--accent); }
        .key-hint { display: block; font-size: 0.6em; opacity: 0.6; margin-bottom: 2px; }

        /* PRO CONTROLS */
        .pro-controls { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px; }
        .btn-talkover {
            background: #ff9800; color: black; font-weight: bold; border: none; border-radius: 5px;
            cursor: pointer; transition: 0.1s; text-transform: uppercase; font-size: 0.8rem;
        }
        .btn-talkover:active, .btn-talkover.active { background: var(--accent); transform: scale(0.98); box-shadow: 0 0 10px var(--accent); }
        .btn-panic {
            background: #b71c1c; color: white; font-weight: bold; border: 1px solid #ff0000; border-radius: 5px;
            cursor: pointer; transition: 0.1s; text-transform: uppercase; font-size: 0.8rem;
        }
        .btn-panic:active { background: red; box-shadow: 0 0 15px red; }

        /* MIXER */
        .mixer-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            background: rgba(0,0,0,0.3); padding: 8px; border-radius: 6px;
        }
        .volume-group { display: flex; flex-direction: column; gap: 3px; }
        .volume-label { font-size: 0.65rem; color: var(--text-gray); font-weight: 600; text-transform: uppercase; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--accent); margin: 0; height: 5px; }
        input#volSfx { accent-color: #009688; }

        /* PLAYER & MEMO */
        .right-bottom-container { flex-grow: 1; display: flex; flex-direction: column; gap: 10px; min-height: 0; }
        .panel-player { flex: 2; display: flex; flex-direction: column; min-height: 0; padding-bottom: 5px; }
        .video-wrapper { flex-grow: 1; width: 100%; background: black; border-radius: 6px; overflow: hidden; border: 1px solid #444; position: relative; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        .panel-memo { flex: 1; display: flex; flex-direction: column; min-height: 100px; }
        textarea#memo-pad { width: 100%; height: 100%; background: #111; border: 1px solid #333; color: #ddd; resize: none; font-family: 'Consolas', monospace; padding: 8px; border-radius: 6px; box-sizing: border-box; font-size: 0.85rem; }
        textarea#memo-pad:focus { outline: 1px solid var(--accent); }

    </style>
</head>
<body>

    <div class="main-grid">
        <div class="colonna">
            <div class="panel">
                <h2>
                    üëÅÔ∏è Monitor Live 
                    <div id="connStatus" class="connection-status disconnected" title="Stato Server"></div>
                </h2>
                
                <div class="timer-box">
                    <div class="timer-display" id="timer">00:00</div>
                    <div class="timer-controls">
                        <button onclick="timerStart()">‚ñ∂</button>
                        <button onclick="timerStop()">‚è∏</button>
                        <button onclick="timerReset()">‚Ü∫</button>
                    </div>
                </div>

                <div class="monitor-grid" id="monitor">
                    <div class="mini-slot" id="mon1">1</div>
                    <div class="mini-slot" id="mon2">2</div>
                    <div class="mini-slot" id="mon3">3</div>
                    <div class="mini-slot" id="mon4">4</div>
                </div>
                <button onclick="resetGara()" class="btn-reset-gara">üîÑ RESET VOTI (X)</button>
                <button onclick="resetTotale()" class="btn-reset-totale">‚ö†Ô∏è Scollega Giudici</button>
            </div>

            <div class="panel panel-playlist">
                <h2>üé§ Scaletta</h2>
                <div class="playlist-container" id="lista-bottoni"></div>
            </div>
        </div>

        <div class="colonna">
            <div class="panel">
                <h2>üéõÔ∏è Audio Pro</h2>
                
                <h3>Music Loop</h3>
                <div class="audio-grid">
                    <button id="btn-sigla" class="btn-sound bg-blue" onclick="toggleMusic('sigla')"><span class="key-hint">[Q]</span>SIGLA</button>
                    <button id="btn-sottofondo" class="btn-sound bg-purple" onclick="toggleMusic('sottofondo')"><span class="key-hint">[W]</span>SOTTOFONDO</button>
                    <button id="btn-suspense" class="btn-sound bg-orange" onclick="toggleMusic('suspense')"><span class="key-hint">[E]</span>SUSPENSE</button>
                    <button id="btn-vittoria" class="btn-sound bg-green" onclick="toggleMusic('vittoria')"><span class="key-hint">[R]</span>VITTORIA</button>
                    <button id="btn-alessandro" class="btn-sound bg-teal" onclick="toggleMusic('alessandro')"><span class="key-hint">[A]</span>SOTTOF. ALE</button>
                </div>

                <h3>Instant SFX</h3>
                <div class="sfx-grid">
                    <button id="btn-applausi" class="btn-sfx" onclick="toggleSfx('applausi')"><span class="key-hint">[1]</span> üëè CLAP</button>
                    <button id="btn-buu" class="btn-sfx" onclick="toggleSfx('buu')"><span class="key-hint">[2]</span> üëé BUUU</button>
                    <button id="btn-rullo" class="btn-sfx" onclick="toggleSfx('rullo')"><span class="key-hint">[3]</span> ü•Å RULLO</button>
                    <button id="btn-grillo" class="btn-sfx" onclick="toggleSfx('grillo')"><span class="key-hint">[4]</span> ü¶ó GRILLO</button>
                </div>

                <div class="pro-controls">
                    <button id="btn-talkover" class="btn-talkover" 
                        onmousedown="setTalkover(true)" onmouseup="setTalkover(false)" 
                        ontouchstart="setTalkover(true)" ontouchend="setTalkover(false)">
                        üé§ TALKOVER [HOLD T]
                    </button>
                    <button class="btn-panic" onclick="panicMode()">üõë PANIC [ESC]</button>
                </div>
                
                <div class="mixer-container">
                    <div class="volume-group">
                        <span class="volume-label">Musica</span>
                        <input type="range" id="volMusic" min="0" max="1" step="0.05" value="0.7" oninput="updateMusicVolume(this.value)">
                    </div>
                    <div class="volume-group">
                        <span class="volume-label">Effetti</span>
                        <input type="range" id="volSfx" min="0" max="1" step="0.05" value="1.0" oninput="updateSfxVolume(this.value)">
                    </div>
                </div>
            </div>

            <div class="right-bottom-container">
                <div class="panel panel-player">
                    <h2>üì∫ Player Video</h2>
                    <div class="video-wrapper"><div id="player"></div></div>
                </div>
                <div class="panel panel-memo">
                    <h2>üìù Note</h2>
                    <textarea id="memo-pad" placeholder="Appunti..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <audio id="track-sigla" src="sigla.mp3" loop></audio>
    <audio id="track-sottofondo" src="sottofondo.mp3" loop></audio>
    <audio id="track-suspense" src="suspense.mp3" loop></audio>
    <audio id="track-vittoria" src="vittoria.mp3"></audio> 
    <audio id="track-alessandro" src="alessandro.mp3" loop></audio>
    
    <audio id="fx-vai" src="vai.mp3"></audio>
    <audio id="sfx-applausi" src="applausi.mp3"></audio>
    <audio id="sfx-buu" src="buu.mp3"></audio>
    <audio id="sfx-rullo" src="rullo.mp3"></audio>
    <audio id="sfx-grillo" src="grillo.mp3"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        // --- 1. CONFIGURAZIONE PLAYLIST ---
        const playlist = [
            { nome: "1. Piccoli aiutanti di BN", id: "yogiJpFmuAA" }, 
            { nome: "2. Tunak Tunak Star Trek",  id: "_NthoWFFZOU" },
            { nome: "3. Chiara gemma",           id: "dSWhxDeMJaA" },
            { nome: "4. Le pizzicate",           id: "HkojXZkXATw" },
            { nome: "5. Sofia Barba",            id: "fQ7Bt10jUfM" },
            { nome: "6. Giacomo Stursi",         id: "3qTDEpO7k8s" },
            { nome: "7. The Little Mix",         id: "1mAwbK9IN0g" },
            { nome: "8. Alessandro e animatori", id: "TJCXKII26rg" },
            { nome: "9. Summer Girls 2010",      id: "czWcyZRAMtk" },
            { nome: "10. Emily Tudisco",         id: "YQsjQiq2-VM" },
            { nome: "11. Francesco Vantaggiato", id: "" },
            { nome: "12. Antonio Botrugno",      id: "GCR5ujxheQg" },
            { nome: "13. Stecchini Duo",         id: "wOxgZCoXRiQ" },
            { nome: "14. Anna Marti",            id: "Kwx-3ihxiCQ" }
        ];

        // --- 2. GENERAZIONE LISTA ---
        const listContainer = document.getElementById('lista-bottoni');
        playlist.forEach((item, index) => {
            const btn = document.createElement('button');
            btn.className = 'btn-concorrente';
            btn.innerHTML = `<span>${item.nome}</span> <small>‚ñ∂</small>`;
            btn.onclick = () => loadVideo(index);
            btn.id = `btn-c-${index}`;
            listContainer.appendChild(btn);
        });

        // --- 3. AUDIO ENGINE ---
        const tracks = {
            sigla: document.getElementById('track-sigla'),
            sottofondo: document.getElementById('track-sottofondo'),
            suspense: document.getElementById('track-suspense'),
            vittoria: document.getElementById('track-vittoria'),
            alessandro: document.getElementById('track-alessandro') // Aggiunto qui
        };
        const sfxVai = document.getElementById('fx-vai');
        const instantSfx = {
            applausi: document.getElementById('sfx-applausi'),
            buu: document.getElementById('sfx-buu'),
            rullo: document.getElementById('sfx-rullo'),
            grillo: document.getElementById('sfx-grillo')
        };

        let musicVolume = 0.7;
        let sfxVolume = 1.0;
        let isTalkoverActive = false;
        let fadeIntervals = {}; 

        // Rimuovi classe playing quando SFX finisce
        Object.keys(instantSfx).forEach(name => {
            instantSfx[name].addEventListener('ended', () => {
                const btn = document.getElementById(`btn-${name}`);
                if(btn) btn.classList.remove('playing');
            });
        });

        function fadeAudio(audio, targetVol, duration, callback) {
            const audioId = audio.id;
            if (fadeIntervals[audioId]) clearInterval(fadeIntervals[audioId]);
            if (targetVol > 0 && audio.paused) { audio.volume = 0; audio.play(); }
            
            const stepTime = 50; 
            const steps = duration / stepTime;
            const volStep = (targetVol - audio.volume) / steps;

            fadeIntervals[audioId] = setInterval(() => {
                let newVol = audio.volume + volStep;
                if ((volStep > 0 && newVol >= targetVol) || (volStep < 0 && newVol <= targetVol)) {
                    audio.volume = targetVol;
                    clearInterval(fadeIntervals[audioId]);
                    delete fadeIntervals[audioId];
                    if (targetVol <= 0.01) { audio.pause(); audio.currentTime = 0; audio.volume = 0; }
                    if (callback) callback();
                } else { audio.volume = newVol; }
            }, stepTime);
        }

        // --- GESTIONE TRACCE MUSICALI ---
        function toggleMusic(name) {
            const audio = tracks[name];
            const btn = document.getElementById(`btn-${name}`);
            const isPlaying = !audio.paused && audio.volume > 0;

            if (isPlaying) {
                fadeAudio(audio, 0, 1000, () => { if(btn) btn.classList.remove('playing'); });
            } else {
                Object.keys(tracks).forEach(key => {
                    if (key !== name && !tracks[key].paused) {
                        fadeAudio(tracks[key], 0, 1000);
                        const other = document.getElementById(`btn-${key}`);
                        if(other) other.classList.remove('playing');
                    }
                });
                if(player && typeof player.pauseVideo === 'function') player.pauseVideo();
                
                let targetV = isTalkoverActive ? musicVolume * 0.2 : musicVolume;
                fadeAudio(audio, targetV, 1000);
                if(btn) btn.classList.add('playing');
            }
        }

        // --- GESTIONE SFX ---
        function toggleSfx(name) {
            const audio = instantSfx[name];
            const btn = document.getElementById(`btn-${name}`);
            const isPlaying = !audio.paused && audio.volume > 0;

            if (isPlaying) {
                fadeAudio(audio, 0, 500, () => { if(btn) btn.classList.remove('playing'); });
            } else {
                fadeAudio(audio, sfxVolume, 500);
                if(btn) btn.classList.add('playing');
            }
        }

        // --- TALKOVER & PANIC ---
        function setTalkover(active) {
            isTalkoverActive = active;
            const btn = document.getElementById('btn-talkover');
            if(active) btn.classList.add('active'); else btn.classList.remove('active');

            Object.values(tracks).forEach(t => {
                if(!t.paused && t.volume > 0) {
                    t.volume = active ? musicVolume * 0.2 : musicVolume;
                }
            });
        }

        function panicMode() {
            if(player && typeof player.stopVideo === 'function') player.stopVideo();
            
            const allAudio = {...tracks, ...instantSfx, vai: sfxVai};
            Object.keys(allAudio).forEach(k => {
                const audio = allAudio[k];
                audio.pause();
                audio.currentTime = 0;
                const btn = document.getElementById(`btn-${k}`);
                if(btn) btn.classList.remove('playing');
            });
            timerStop();
        }

        // --- LIVE VOLUME UPDATES ---
        function updateMusicVolume(val) {
            musicVolume = parseFloat(val);
            Object.values(tracks).forEach(t => { 
                if (!t.paused && t.volume > 0) {
                    t.volume = isTalkoverActive ? musicVolume * 0.2 : musicVolume;
                }
            });
        }

        function updateSfxVolume(val) {
            sfxVolume = parseFloat(val);
            Object.values(instantSfx).forEach(s => { if (!s.paused) s.volume = sfxVolume; });
            sfxVai.volume = sfxVolume;
        }

        // --- TIMER ---
        let timerInterval;
        let timerSeconds = 0;
        const timerDisplay = document.getElementById('timer');
        function updateTimerDisplay() {
            const m = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
            const s = (timerSeconds % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${m}:${s}`;
        }
        function timerStart() { if(!timerInterval) timerInterval = setInterval(() => { timerSeconds++; updateTimerDisplay(); }, 1000); }
        function timerStop() { clearInterval(timerInterval); timerInterval = null; }
        function timerReset() { timerStop(); timerSeconds = 0; updateTimerDisplay(); }

        // --- MEMO ---
        const memoPad = document.getElementById('memo-pad');
        if(localStorage.getItem('regiaMemo')) memoPad.value = localStorage.getItem('regiaMemo');
        memoPad.addEventListener('input', () => localStorage.setItem('regiaMemo', memoPad.value));

        // --- TASTIERA ---
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
            
            const key = e.key.toLowerCase();
            
            if (e.code === 'Space') { e.preventDefault(); panicMode(); return; }
            if (e.code === 'Escape') { panicMode(); return; }
            if (key === 't' && !e.repeat) setTalkover(true);

            switch(key) {
                case '1': toggleSfx('applausi'); break;
                case '2': toggleSfx('buu'); break;
                case '3': toggleSfx('rullo'); break;
                case '4': toggleSfx('grillo'); break;
                case 'q': toggleMusic('sigla'); break;
                case 'w': toggleMusic('sottofondo'); break;
                case 'e': toggleMusic('suspense'); break;
                case 'r': toggleMusic('vittoria'); break;
                case 'a': toggleMusic('alessandro'); break; // NUOVO TASTO
            }
        });

        document.addEventListener('keyup', (e) => {
             if (e.key.toLowerCase() === 't') setTalkover(false);
        });

        // --- YOUTUBE ---
        let player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: '',
                playerVars: { 'playsinline': 1, 'rel': 0, 'origin': window.location.origin },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }
        function onPlayerReady(event) { console.log("Player pronto"); }
        function onPlayerStateChange(event) { if (event.data === YT.PlayerState.ENDED) player.stopVideo(); }
        function loadVideo(index) {
            document.querySelectorAll('.btn-concorrente').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-c-${index}`).classList.add('active');
            timerReset();
            
            const videoId = playlist[index].id;
            if (videoId && videoId.trim() !== "") {
                player.loadVideoById(videoId);
                Object.values(tracks).forEach(t => { if(!t.paused) fadeAudio(t, 0, 500); });
                document.querySelectorAll('.btn-sound').forEach(b => b.classList.remove('playing'));
            } else {
                player.stopVideo();
                alert(`‚ö†Ô∏è Nessun video per: ${playlist[index].nome}`);
            }
        }

        // --- SOCKET & STATUS ---
        const socket = io();
        const connStatus = document.getElementById('connStatus');

        socket.on('connect', () => {
            connStatus.classList.remove('disconnected');
            connStatus.classList.add('connected');
            connStatus.title = "Server Connesso";
        });

        socket.on('disconnect', () => {
            connStatus.classList.remove('connected');
            connStatus.classList.add('disconnected');
            connStatus.title = "DISCONNESSO!";
        });

        socket.on('aggiorna', (stato) => {
            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById(`mon${i}`);
                if (stato[i].nome) {
                    el.innerHTML = `${stato[i].nome}`;
                    el.classList.toggle('attivo', stato[i].scelta === 'X');
                } else {
                    el.innerHTML = `${i}`;
                    el.classList.remove('attivo');
                }
            }
        });
        socket.on('suono', (scelta) => { if (scelta === 'X') { sfxVai.currentTime = 0; sfxVai.volume = sfxVolume; sfxVai.play(); } });
        
        function resetGara() { 
            socket.emit('reset'); 
            timerReset(); 
            if(!tracks.suspense.paused) toggleMusic('suspense'); 
        }
        function resetTotale() { if(confirm("Scollegare tutti?")) socket.emit('reset-giudici'); }

    </script>
</body>
</html>
